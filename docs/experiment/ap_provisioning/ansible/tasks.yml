- name: Add tasks for Debian distributions
  import_tasks: debian_tasks.yml
  when: ansible_distribution == 'Debian'
- name: Add tasks for Ubuntu distributions
  import_tasks: ubuntu_tasks.yml
  when: ansible_distribution == 'Ubuntu'  
- name: Install packages via apt
  apt:
    name: 
      - hostapd
      - tcpdump
      - dnsmasq
    state: present
    update_cache: yes
- name: Enable IP forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    sysctl_set: yes
- name: Configure hostapd
  template:
    src: hostapd.conf
    dest: /etc/hostapd/hostapd.conf
- name: Configure dnsmasq
  template:
    src: dnsmasq.conf
    dest: /etc/dnsmasq.conf
- name: Configure interface
  command: "{{item}}"
  with_items:
    - "ip addr flush dev {{WLAN_INTERFACE}}"
    - "ip link set up dev {{WLAN_INTERFACE}}"
    - "ip addr add {{WLAN_ADDR}} dev {{WLAN_INTERFACE}}"
- name: Restart and enable dnsmasq
  service:
    name: dnsmasq
    state: restarted
    enabled: yes
- name: Unmask hostapd
  command: systemctl unmask hostapd
  ignore_errors: yes
- name: Restart and enable hostapd
  service:
    name: hostapd
    state: restarted
    enabled: yes
- name: Add NAT rules
  iptables:
    chain: POSTROUTING
    table: nat
    out_interface: "{{GATEWAY_INTERFACE}}"
    jump: MASQUERADE
